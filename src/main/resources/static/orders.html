<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - Inventory Management</title>
    <link rel="stylesheet" href="css/style-enhanced.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-warehouse"></i>
                <span>Inventory Manager</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="inventory.html" class="nav-link"><i class="fas fa-boxes"></i> Inventory</a></li>
                <li><a href="suppliers.html" class="nav-link active"><i class="fas fa-truck"></i> Suppliers</a></li>
                <li><a href="orders.html" class="nav-link"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                <li><a href="warehouses.html" class="nav-link"><i class="fas fa-building"></i> Warehouses</a></li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-shopping-cart"></i> Order Management</h1>
            <button class="btn btn-primary" onclick="showCreateOrderModal()">
                <i class="fas fa-plus"></i> Create Order
            </button>
        </div>

        <!-- Filter Controls -->
        <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem; align-items:flex-end;">
            <div style="display:flex; flex-direction:column; flex:1; min-width:150px;">
                <label for="statusFilter" style="margin-bottom:0.25rem; font-weight:500; color:#2d3748;">Status:</label>
                <select id="statusFilter" onchange="filterOrders()" style="padding:0.5rem; border:1px solid #e2e8f0; border-radius:5px; font-size:1rem;">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="CONFIRMED">Confirmed</option>
                    <option value="SHIPPED">Shipped</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="CANCELLED">Cancelled</option>
                    <option value="DELAYED">Delayed</option>
                </select>
            </div>
            <div style="display:flex; flex-direction:column; flex:1; min-width:150px;">
                <label for="typeFilter" style="margin-bottom:0.25rem; font-weight:500; color:#2d3748;">Type:</label>
                <select id="typeFilter" onchange="filterOrders()" style="padding:0.5rem; border:1px solid #e2e8f0; border-radius:5px; font-size:1rem;">
                    <option value="">All Types</option>
                    <option value="PURCHASE">Purchase</option>
                    <option value="SALE">Sale</option>
                    <option value="TRANSFER">Transfer</option>
                </select>
            </div>
            <div style="display:flex; flex-direction:column; flex:1; min-width:150px;">
                <label for="supplierFilter" style="margin-bottom:0.25rem; font-weight:500; color:#2d3748;">Supplier:</label>
                <select id="supplierFilter" onchange="filterOrders()" style="padding:0.5rem; border:1px solid #e2e8f0; border-radius:5px; font-size:1rem;">
                    <option value="">All Suppliers</option>
                </select>
            </div>
            <div style="display:flex; flex-direction:column; flex:1; min-width:200px;">
                <label for="searchInput" style="margin-bottom:0.25rem; font-weight:500; color:#2d3748;">Search:</label>
                <input type="text" id="searchInput" placeholder="Search by order number..." onkeyup="filterOrders()" style="padding:0.5rem; border:1px solid #e2e8f0; border-radius:5px; font-size:1rem;">
            </div>
</div>


        <!-- Orders Grid -->
        <div class="table-container" style="overflow-x:auto; margin-top: 1.5rem;">
        <table id="ordersTable" style="width:100%; border-collapse: collapse; min-width: 800px;">
            <thead>
                <tr style="background-color:#f7fafc; color:#2d3748; text-align:left; font-weight:600;">
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Order Number</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Type</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Status</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Supplier</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Order Date</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Total Amount</th>
                    <th style="padding: 0.75rem 1rem; border-bottom:1px solid #e2e8f0;">Actions</th>
                </tr>
            </thead>
            <tbody id="ordersContainer">
                <!-- Orders will be loaded here -->
            </tbody>
        </table>
    </div>

        <div id="loadingSpinner" class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Loading orders...
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-shopping-cart"></i>
            <h3>No Orders Found</h3>
            <p>Create your first order to get started.</p>
            <button class="btn btn-primary" onclick="showCreateOrderModal()">
                <i class="fas fa-plus"></i> Create Order
            </button>
        </div>
    </div>

    <!-- Create/Edit Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create Order</h2>
                <span class="close" onclick="closeOrderModal()">&times;</span>
            </div>
            <form id="orderForm" onsubmit="saveOrder(event)">
                <div class="form-group">
                    <label for="orderNumber">Order Number:</label>
                    <input type="text" id="orderNumber" name="orderNumber" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="orderType">Type:</label>
                        <select id="orderType" name="type" required onchange="toggleSupplierField()">
                            <option value="">Select Type</option>
                            <option value="PURCHASE">Purchase</option>
                            <option value="SALE">Sale</option>
                            <option value="TRANSFER">Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="supplierGroup">
                        <label for="supplierId">Supplier:</label>
                        <select id="supplierId" name="supplierId">
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="orderDate">Order Date:</label>
                        <input type="datetime-local" id="orderDate" name="orderDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expectedDeliveryDate">Expected Delivery:</label>
                        <input type="datetime-local" id="expectedDeliveryDate" name="expectedDeliveryDate">
                    </div>
                </div>

                <div class="form-group">
                    <label for="orderStatus">Status:</label>
                    <select id="orderStatus" name="status" required>
                        <option value="PENDING">Pending</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="SHIPPED">Shipped</option>
                        <option value="DELIVERED">Delivered</option>
                        <option value="CANCELLED">Cancelled</option>
                        <option value="DELAYED">Delayed</option>
                    </select>
                </div>

                <!-- Order Items Section -->
                <div class="order-items-section">
                    <div class="section-header">
                        <h3>Order Items</h3>
                        <button type="button" class="btn btn-secondary" onclick="addOrderItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div id="orderItemsContainer">
                        <!-- Order items will be added here -->
                    </div>
                    <div class="order-total">
                        <strong>Total Amount: $<span id="totalAmount">0.00</span></strong>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
            </div>
            <div id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
      

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadSuppliers();
            loadProducts();
            setDefaultOrderDate();
        });

        function setDefaultOrderDate() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('orderDate').value = now.toISOString().slice(0, 16);
        }

        async function loadOrders() {
            try {
                showLoading(true);
                const response = await ApiClient.get('/orders');
                allOrders = response;
                displayOrders(allOrders);
                showLoading(false);
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Error loading orders', 'error');
                showLoading(false);
            }
        }

        async function loadSuppliers() {
            try {
                const suppliers = await ApiClient.get('/suppliers');
                availableSuppliers = suppliers;
                
                const supplierSelect = document.getElementById('supplierId');
                const supplierFilter = document.getElementById('supplierFilter');
                
                supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
                supplierFilter.innerHTML = '<option value="">All Suppliers</option>';
                
                suppliers.forEach(supplier => {
                    supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                    supplierFilter.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        async function loadProducts() {
            try {
                const products = await ApiClient.get('/products');
                availableProducts = products;
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

       
            function displayOrders(orders) {
                const container = document.getElementById('ordersContainer');
                const emptyState = document.getElementById('emptyState');

                if (orders.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';

                container.innerHTML = orders.map(order => `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                        <td style="padding:0.75rem 1rem;"><strong>${order.orderNumber}</strong></td>
                                <td style="padding:0.75rem 1rem;">
                                    <span style="
                                        display:inline-block; 
                                        padding:0.25rem 0.75rem; 
                                        border-radius:12px; 
                                        font-size:0.8rem; 
                                        font-weight:bold; 
                                        text-transform:uppercase; 
                                color:white; 
                                background-color:${order.type.toLowerCase() === 'purchase' ? '#1976d2' : '#388e3c'};">
                                ${order.type}
                            </span>
                        </td>
                        <td style="padding:0.75rem 1rem;">
                            <span style="
                                display:inline-block; 
                                padding:0.25rem 0.75rem; 
                                border-radius:12px; 
                                font-size:0.8rem; 
                                font-weight:bold; 
                                text-transform:uppercase; 
                                color:white; 
                                background-color:${getStatusColor(order.status)};">
                                ${order.status}
                            </span>
                        </td>
                        <td style="padding:0.75rem 1rem;">${order.supplier ? order.supplier.name : 'N/A'}</td>
                        <td style="padding:0.75rem 1rem;">${formatDate(order.orderDate)}</td>
                        <td style="padding:0.75rem 1rem;"><strong>$${(order.totalAmount || 0).toFixed(2)}</strong></td>
                        <td style="padding:0.75rem 1rem;">
                            <button onclick="viewOrderDetails(${order.id})" style="margin-right:0.3rem; padding:0.4rem 0.6rem; border:none; border-radius:5px; background:#3498db; color:white; cursor:pointer;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editOrder(${order.id})" style="margin-right:0.3rem; padding:0.4rem 0.6rem; border:none; border-radius:5px; background:#2ecc71; color:white; cursor:pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteOrder(${order.id})" style="padding:0.4rem 0.6rem; border:none; border-radius:5px; background:#e74c3c; color:white; cursor:pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

        // Helper function for status badge colors
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'pending': return '#f39c12';
                case 'confirmed': return '#3498db';
                case 'shipped': return '#9b59b6';
                case 'delivered': return '#2ecc71';
                case 'cancelled': return '#e74c3c';
                case 'delayed': return '#c2185b';
                default: return '#95a5a6';
            }
        }


        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const supplierFilter = document.getElementById('supplierFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filteredOrders = allOrders.filter(order => {
                const matchesStatus = !statusFilter || order.status === statusFilter;
                const matchesType = !typeFilter || order.type === typeFilter;
                const matchesSupplier = !supplierFilter || (order.supplier && order.supplier.id.toString() === supplierFilter);
                const matchesSearch = !searchTerm || order.orderNumber.toLowerCase().includes(searchTerm);

                return matchesStatus && matchesType && matchesSupplier && matchesSearch;
            });

            displayOrders(filteredOrders);
        }

        function showCreateOrderModal() {
            currentOrder = null;
            document.getElementById('modalTitle').textContent = 'Create Order';
            document.getElementById('orderForm').reset();
            document.getElementById('orderItemsContainer').innerHTML = '';
            orderItemIndex = 0;
            updateTotalAmount();
            setDefaultOrderDate();
            document.getElementById('orderModal').style.display = 'block';
        }

        function toggleSupplierField() {
            const orderType = document.getElementById('orderType').value;
            const supplierGroup = document.getElementById('supplierGroup');
            
            if (orderType === 'TRANSFER') {
                supplierGroup.style.display = 'none';
                document.getElementById('supplierId').value = '';
            } else {
                supplierGroup.style.display = 'block';
            }
        }

        function addOrderItem() {
            const container = document.getElementById('orderItemsContainer');
            const itemHtml = `
                <div class="order-item" data-index="${orderItemIndex}">
                    <div class="order-item-header">
                        <h4>Item ${orderItemIndex + 1}</h4>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeOrderItem(${orderItemIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Product:</label>
                            <select name="productId" required onchange="updateItemPrice(${orderItemIndex})">
                                <option value="">Select Product</option>
                                ${availableProducts.map(product => 
                                    `<option value="${product.id}" data-price="${product.price}">${product.name} (${product.sku})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity:</label>
                            <input type="number" name="quantity" min="1" required onchange="updateTotalAmount()">
                        </div>
                        <div class="form-group">
                            <label>Unit Price:</label>
                            <input type="number" name="unitPrice" step="0.01" min="0" required onchange="updateTotalAmount()">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHtml);
            orderItemIndex++;
        }

        function removeOrderItem(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
                updateTotalAmount();
            }
        }

        function updateItemPrice(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            const productSelect = item.querySelector('select[name="productId"]');
            const priceInput = item.querySelector('input[name="unitPrice"]');
            
            const selectedOption = productSelect.selectedOptions[0];
            if (selectedOption && selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
                updateTotalAmount();
            }
        }

        function updateTotalAmount() {
            const items = document.querySelectorAll('.order-item');
            let total = 0;

            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('input[name="quantity"]').value) || 0;
                const unitPrice = parseFloat(item.querySelector('input[name="unitPrice"]').value) || 0;
                total += quantity * unitPrice;
            });

            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

            async function saveOrder(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const orderData = {
                    type: formData.get('type'),
                    supplierId: formData.get('supplierId') ? parseInt(formData.get('supplierId')) : null,
                    items: []
                };

                // Collect order items
                const items = [];
                const orderItems = document.querySelectorAll('.order-item');
                
                orderItems.forEach(item => {
                    const productId = item.querySelector('select[name="productId"]').value;
                    const quantity = parseInt(item.querySelector('input[name="quantity"]').value);
                    const unitPrice = parseFloat(item.querySelector('input[name="unitPrice"]').value);
                    
                    if (productId && quantity && unitPrice) {
                        items.push({ 
                            product: { id: parseInt(productId) },
                            quantity: quantity,
                            unitPrice: unitPrice 
                        });
                    }
                });

                orderData.items = items;

                let response;
                if (currentOrder) {
                    response = await ApiClient.put(`/orders/${currentOrder.id}`, orderData);
                } else {
                    response = await ApiClient.post('/orders', orderData);
                }

                // ✅ Use backend-calculated totalAmount
                const savedOrder = response; // ApiClient already returns JSON
                if (savedOrder && typeof savedOrder.totalAmount !== "undefined") {
                    const totalAmountEl = document.getElementById('totalAmount');
                    if (totalAmountEl) {
                        totalAmountEl.textContent = (savedOrder.totalAmount || 0).toFixed(2);
                    }
                }

                showNotification(
                    currentOrder ? 'Order updated successfully' : 'Order created successfully',
                    'success'
                );

                closeOrderModal();
                loadOrders(); 
            } catch (error) {
                console.error('Error saving order:', error);
                showNotification('Error saving order', 'error');
            }
        }

        async function editOrder(id) {
            try {
                const order = await ApiClient.get(`/orders/${id}`);
                currentOrder = order;
                
                document.getElementById('modalTitle').textContent = 'Edit Order';
                document.getElementById('orderNumber').value = order.orderNumber;
                document.getElementById('orderType').value = order.type;
                document.getElementById('orderStatus').value = order.status;
                document.getElementById('supplierId').value = order.supplier ? order.supplier.id : '';
                
                // Format dates for datetime-local input
                document.getElementById('orderDate').value = formatDateForInput(order.orderDate);
                if (order.expectedDeliveryDate) {
                    document.getElementById('expectedDeliveryDate').value = formatDateForInput(order.expectedDeliveryDate);
                }

                // Load order items
                const container = document.getElementById('orderItemsContainer');
                container.innerHTML = '';
                orderItemIndex = 0;

                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        addOrderItem();
                        const itemElement = container.lastElementChild;
                        itemElement.querySelector('select[name="productId"]').value = item.product.id;
                        itemElement.querySelector('input[name="quantity"]').value = item.quantity;
                        itemElement.querySelector('input[name="unitPrice"]').value = item.unitPrice;
                    });
                }

                updateTotalAmount();
                toggleSupplierField();
                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading order:', error);
                showNotification('Error loading order details', 'error');
            }
        }

        async function viewOrderDetails(id) {
            try {
                const order = await ApiClient.get(`/orders/${id}`);
                
                const detailsHtml = `
                    <div class="order-details">
                        <div class="details-header">
                            <div class="detail-item">
                                <strong>Order Number:</strong> ${order.orderNumber}
                            </div>
                            <div class="detail-item">
                                <strong>Type:</strong> <span class="badge badge-${order.type.toLowerCase()}">${order.type}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Status:</strong> <span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span>
                            </div>
                        </div>
                        
                        <div class="details-row">
                            <div class="detail-item">
                                <strong>Order Date:</strong> ${formatDate(order.orderDate)}
                            </div>
                            <div class="detail-item">
                                <strong>Expected Delivery:</strong> ${order.expectedDeliveryDate ? formatDate(order.expectedDeliveryDate) : 'Not set'}
                            </div>
                            <div class="detail-item">
                                <strong>Actual Delivery:</strong> ${order.actualDeliveryDate ? formatDate(order.actualDeliveryDate) : 'Not delivered'}
                            </div>
                        </div>

                        ${order.supplier ? `
                            <div class="detail-item">
                                <strong>Supplier:</strong> ${order.supplier.name}
                                ${order.supplier.contactPerson ? `<br><small>Contact: ${order.supplier.contactPerson}</small>` : ''}
                                ${order.supplier.email ? `<br><small>Email: ${order.supplier.email}</small>` : ''}
                            </div>
                        ` : ''}

                        <div class="order-items-details">
                            <h3>Order Items</h3>
                            ${order.items && order.items.length > 0 ? `
                                <div class="items-table">
                                    <div class="table-header">
                                        <div>Product</div>
                                        <div>Quantity</div>
                                        <div>Unit Price</div>
                                        <div>Total</div>
                                    </div>
                                    ${order.items.map(item => `
                                        <div class="table-row">
                                            <div>
                                                <strong>${item.product.name}</strong><br>
                                                <small>SKU: ${item.product.sku}</small>
                                            </div>
                                            <div>${item.quantity}</div>
                                            <div>$${item.unitPrice.toFixed(2)}</div>
                                            <div>$${(item.quantity * item.unitPrice).toFixed(2)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="total-amount">
                                    <strong>Total Amount: $${(order.totalAmount || 0).toFixed(2)}</strong>
                                </div>
                            ` : '<p>No items in this order.</p>'}
                        </div>
                    </div>
                `;

                document.getElementById('orderDetailsContent').innerHTML = detailsHtml;
                document.getElementById('orderDetailsModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading order details:', error);
                showNotification('Error loading order details', 'error');
            }
        }

        async function deleteOrder(id) {
            if (!confirm('Are you sure you want to delete this order?')) {
                return;
            }

            try {
                await ApiClient.delete(`/orders/${id}`);
                showNotification('Order deleted successfully', 'success');
                loadOrders();
            } catch (error) {
                console.error('Error deleting order:', error);
                showNotification('Error deleting order', 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            currentOrder = null;
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 16);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const orderModal = document.getElementById('orderModal');
            const detailsModal = document.getElementById('orderDetailsModal');
            
            if (event.target === orderModal) {
                closeOrderModal();
            }
            if (event.target === detailsModal) {
                closeOrderDetailsModal();
            }
        }
    </script>
</body>
</html>